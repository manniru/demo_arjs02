<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Use the title from a page's frontmatter if it has one -->
  <title>threejs + webcam</title>
  <link href="stylesheets/bootstrap.css" rel="stylesheet" />
  <link href="stylesheets/site.css" rel="stylesheet" />
  <script src="javascripts/jquery-3.3.1.js"></script>
  <script src="javascripts/underscore.js"></script>
  <script src="javascripts/site.js"></script>
</head>
<body>
<div class="container-fluid">
  <div id="three-scene-card" class="card border-primary w-100 h-100">
  <div class="card-header">threejs + webcam</div>
  <div class="card-body" id="three-scene">
    <video id="camvideo" hidden></video>
  </div>
  <div class="card-footer">
    Data :
    <scan id="qrcode-data">No data detected</scan>
  </div>
</div>

<script src="javascripts/three.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script type="text/javascript">

  try {
    sceneWidth = $('#three-scene').width() - 15;
    sceneHeight = $('#three-scene').height();

    var camVideo = document.getElementById('camvideo');
    camVideo.width = sceneWidth;
    camVideo.height = sceneHeight;
    navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}, audio: false})
      .then(function (stream) {
        camVideo.srcObject = stream;
        camVideo.play();
      })
      .catch(function (err) {
        $('#qrcode-data').html('error' + err.message);
      });

    var scene = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera(75, sceneWidth / sceneHeight, 1, 1000);
    var renderer = new THREE.WebGLRenderer({antialias: false});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(sceneWidth, sceneHeight);
    container = document.getElementById('container');
    $('#three-scene').append(renderer.domElement);

    camera.position.z = 5;

    var controls = new THREE.OrbitControls(camera);
    controls.update();

    var geometry = new THREE.BoxGeometry(2, 2, 2);
    var material = new THREE.MeshBasicMaterial({color: 'red'});
    var cube = new THREE.Mesh(geometry, material);
    scene.add(cube);

    //video
    videoImage = document.createElement('canvas');
    videoImage.width = sceneWidth;
    videoImage.height = sceneHeight;

    videoImageContext = videoImage.getContext('2d');
    // background color if no video present
    videoImageContext.fillStyle = '#000000';
    videoImageContext.fillRect(0, 0, videoImage.width, videoImage.height);

    videoTexture = new THREE.Texture(videoImage);
    videoTexture.minFilter = THREE.LinearFilter;
    videoTexture.magFilter = THREE.LinearFilter;

    movieMaterial = new THREE.MeshBasicMaterial({map: videoTexture});
    movieGeometry = new THREE.PlaneGeometry(2, 2, 0);
    movieScreen = new THREE.Mesh(movieGeometry, movieMaterial);
    movieScreen.material.depthTest = false;
    movieScreen.material.depthWrite = false;

    backgroundScene = new THREE.Scene();
    backgroundCamera = new THREE.Camera();
    backgroundScene.add(backgroundCamera);
    backgroundScene.add(movieScreen);

    var animate = function () {
      requestAnimationFrame(animate);
      renderer.clear();
      cube.rotation.x += 0.001;
      cube.rotation.y += 0.001;
      if (camVideo.readyState === camVideo.HAVE_ENOUGH_DATA) {
        videoImageContext.drawImage(camVideo, 0, 0);
        if (videoTexture)
          videoTexture.needsUpdate = true;
      }

      renderer.autoClear = false;
      controls.update();

      renderer.render(backgroundScene, backgroundCamera);
      renderer.render(scene, camera);
    };
    animate();

  } catch (err) {
    $('#qrcode-data').html('error' + err.message);
  }
</script>

</div>

</body>
</html>
