!function(){"use strict";function t(){g.forEach(function(t){M[t]=Module[t]});for(var t in Module)t.match(/^AR/)&&(M[t]=Module[t])}function e(t,e,r){var i="/marker_"+m++;h(e,i,function(){var e=Module._addMarker(t,i);r&&r(e)})}function r(t){return String.fromCharCode.apply(String,t)}function i(t){var e=r(t),i=e.split("\n"),a=[],o=0,n=0;return i.forEach(function(t){if((t=t.trim())&&!t.startsWith("#"))switch(o){case 0:return n=+t,void(o=1);case 1:t.match(/^\d+$/)||a.push(t);case 2:case 3:case 4:return void o++;case 5:return void(o=1)}}),a}function a(t,e,r){var a="/multi_marker_"+f++;h(e,a,function(o){function n(){var e=Module._addMultiMarker(t,a),i=Module.getMultiMarkerNum(t,e);r&&r(e,i)}var s=i(o);if(!s.length)return n();var h=e.split("/").slice(0,-1).join("/");s=s.map(function(t){return[h+"/"+t,t]}),d(s,n)})}function o(t,e){var r="/camera_param_"+p++,i=function(){var t=Module._loadCamera(r);e&&e(t)};"object"==typeof t?s(r,t,i):t.indexOf("\n")>-1?n(r,t,i):h(t,r,i)}function n(t,e,r){for(var i=new Uint8Array(e.length),a=0;a<i.length;a++)i[a]=255&e.charCodeAt(a);s(t,i,r)}function s(t,e,r){FS.writeFile(t,e,{encoding:"binary"}),r(e)}function h(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){var t=i.response,a=new Uint8Array(t);s(e,a,r)},i.send()}function d(t,e){var r=t.pop();r?h(r[0],r[1],function(){d(t,e)}):e()}var u=function(t,e,r){var i=t,a=e;if(this.orientation="landscape",this.listeners={},"number"!=typeof t){var o=t;r=e,i=o.videoWidth||o.width,a=o.videoHeight||o.height,this.image=o}if(this.defaultMarkerWidth=1,this.patternMarkers={},this.barcodeMarkers={},this.transform_mat=new Float32Array(16),this.canvas=document.createElement("canvas"),this.canvas.width=i,this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.videoWidth=i,this.videoHeight=a,"string"==typeof r){var n=this;this.cameraParam=new c(r,function(){n._initialize()},function(t){console.error("ARController: Failed to load ARCameraParam",t)})}else this.cameraParam=r,this._initialize()};u.prototype.dispose=function(){M.teardown(this.id);for(var t in this)this[t]=null},u.prototype.process=function(t){this.detectMarker(t);var e,r,i=this.getMarkerNum();for(e in this.patternMarkers)r=this.patternMarkers[e],r.inPrevious=r.inCurrent,r.inCurrent=!1;for(e in this.barcodeMarkers)r=this.barcodeMarkers[e],r.inPrevious=r.inCurrent,r.inCurrent=!1;var a,o,n,s;for(a=0;a<i;a++){var h=this.getMarker(a),d=M.UNKNOWN_MARKER;n=this.trackPatternMarkerId(-1),h.idPatt>-1&&(h.id===h.idPatt||-1===h.idMatrix)?(n=this.trackPatternMarkerId(h.idPatt),d=M.PATTERN_MARKER,h.dir!==h.dirPatt&&this.setMarkerInfoDir(a,h.dirPatt)):h.idMatrix>-1&&(n=this.trackBarcodeMarkerId(h.idMatrix),d=M.BARCODE_MARKER,h.dir!==h.dirMatrix&&this.setMarkerInfoDir(a,h.dirMatrix)),d!==M.UNKNOWN_MARKER&&n.inPrevious?this.getTransMatSquareCont(a,n.markerWidth,n.matrix,n.matrix):this.getTransMatSquare(a,n.markerWidth,n.matrix),n.inCurrent=!0,this.transMatToGLMat(n.matrix,this.transform_mat),this.dispatchEvent({name:"getMarker",target:this,data:{index:a,type:d,marker:h,matrix:this.transform_mat}})}var u=this.getMultiMarkerCount();for(a=0;a<u;a++){var c=this.getMultiMarkerPatternCount(a);for(n=!1,M.getTransMatMultiSquareRobust(this.id,a),this.transMatToGLMat(this.marker_transform_mat,this.transform_mat),o=0;o<c;o++)if(s=this.getMultiEachMarker(a,o),s.visible>=0){n=!0,this.dispatchEvent({name:"getMultiMarker",target:this,data:{multiMarkerId:a,matrix:this.transform_mat}});break}if(n)for(o=0;o<c;o++)s=this.getMultiEachMarker(a,o),this.transMatToGLMat(this.marker_transform_mat,this.transform_mat),this.dispatchEvent({name:"getMultiMarkerSub",target:this,data:{multiMarkerId:a,markerIndex:o,marker:s,matrix:this.transform_mat}})}this._bwpointer&&this.debugDraw()},u.prototype.trackPatternMarkerId=function(t,e){var r=this.patternMarkers[t];return r||(this.patternMarkers[t]=r={inPrevious:!1,inCurrent:!1,matrix:new Float32Array(12),markerWidth:e||this.defaultMarkerWidth}),e&&(r.markerWidth=e),r},u.prototype.trackBarcodeMarkerId=function(t,e){var r=this.barcodeMarkers[t];return r||(this.barcodeMarkers[t]=r={inPrevious:!1,inCurrent:!1,matrix:new Float32Array(12),markerWidth:e||this.defaultMarkerWidth}),e&&(r.markerWidth=e),r},u.prototype.getMultiMarkerCount=function(){return M.getMultiMarkerCount(this.id)},u.prototype.getMultiMarkerPatternCount=function(t){return M.getMultiMarkerNum(this.id,t)},u.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},u.prototype.removeEventListener=function(t,e){if(this.listeners[t]){var r=this.listeners[t].indexOf(e);r>-1&&this.listeners[t].splice(r,1)}},u.prototype.dispatchEvent=function(t){var e=this.listeners[t.name];if(e)for(var r=0;r<e.length;r++)e[r].call(this,t)},u.prototype.debugSetup=function(){document.body.appendChild(this.canvas),this.setDebugMode(1),this._bwpointer=this.getProcessingImage()},u.prototype.loadMarker=function(t,e,r){return M.addMarker(this.id,t,e,r)},u.prototype.loadMultiMarker=function(t,e,r){return M.addMultiMarker(this.id,t,e,r)},u.prototype.getTransMatSquare=function(t,e,r){return M.getTransMatSquare(this.id,t,e),r.set(this.marker_transform_mat),r},u.prototype.getTransMatSquareCont=function(t,e,r,i){return this.marker_transform_mat.set(r),M.getTransMatSquareCont(this.id,t,e),i.set(this.marker_transform_mat),i},u.prototype.getTransMatMultiSquare=function(t,e){return M.getTransMatMultiSquare(this.id,t),e.set(this.marker_transform_mat),e},u.prototype.getTransMatMultiSquareRobust=function(t,e){return M.getTransMatMultiSquare(this.id,t),e.set(this.marker_transform_mat),e},u.prototype.transMatToGLMat=function(t,e,r){return e[0]=t[0],e[4]=t[1],e[8]=t[2],e[12]=t[3],e[1]=t[4],e[5]=t[5],e[9]=t[6],e[13]=t[7],e[2]=t[8],e[6]=t[9],e[10]=t[10],e[14]=t[11],e[3]=0,e[7]=0,e[11]=0,e[15]=1,r!=undefined&&0!==r&&(e[12]*=r,e[13]*=r,e[14]*=r),e},u.prototype.detectMarker=function(t){return this._copyImageToHeap(t)?M.detectMarker(this.id):-99},u.prototype.getMarkerNum=function(){return M.getMarkerNum(this.id)},u.prototype.getMarker=function(t){if(0===M.getMarker(this.id,t))return M.markerInfo},u.prototype.setMarkerInfoVertex=function(t,e){for(var r=0;r<e.length;r++)this.marker_transform_mat[2*r+0]=e[r][0],this.marker_transform_mat[2*r+1]=e[r][1];return M.setMarkerInfoVertex(this.id,t)},u.prototype.cloneMarkerInfo=function(t){return JSON.parse(JSON.stringify(t))},u.prototype.getMultiEachMarker=function(t,e){if(0===M.getMultiEachMarker(this.id,t,e))return M.multiEachMarkerInfo},u.prototype.getTransformationMatrix=function(){return this.transform_mat},u.prototype.getCameraMatrix=function(){return this.camera_mat},u.prototype.getMarkerTransformationMatrix=function(){return this.marker_transform_mat},u.prototype.setDebugMode=function(t){return M.setDebugMode(this.id,t)},u.prototype.getDebugMode=function(){return M.getDebugMode(this.id)},u.prototype.getProcessingImage=function(){return M.getProcessingImage(this.id)},u.prototype.setLogLevel=function(t){return M.setLogLevel(t)},u.prototype.getLogLevel=function(){return M.getLogLevel()},u.prototype.setMarkerInfoDir=function(t,e){return M.setMarkerInfoDir(this.id,t,e)},u.prototype.setProjectionNearPlane=function(t){return M.setProjectionNearPlane(this.id,t)},u.prototype.getProjectionNearPlane=function(){return M.getProjectionNearPlane(this.id)},u.prototype.setProjectionFarPlane=function(t){return M.setProjectionFarPlane(this.id,t)},u.prototype.getProjectionFarPlane=function(){return M.getProjectionFarPlane(this.id)},u.prototype.setThresholdMode=function(t){return M.setThresholdMode(this.id,t)},u.prototype.getThresholdMode=function(){return M.getThresholdMode(this.id)},u.prototype.setThreshold=function(t){return M.setThreshold(this.id,t)},u.prototype.getThreshold=function(){return M.getThreshold(this.id)},u.prototype.setPatternDetectionMode=function(t){return M.setPatternDetectionMode(this.id,t)},u.prototype.getPatternDetectionMode=function(){return M.getPatternDetectionMode(this.id)},u.prototype.setMatrixCodeType=function(t){return M.setMatrixCodeType(this.id,t)},u.prototype.getMatrixCodeType=function(){return M.getMatrixCodeType(this.id)},u.prototype.setLabelingMode=function(t){return M.setLabelingMode(this.id,t)},u.prototype.getLabelingMode=function(){return M.getLabelingMode(this.id)},u.prototype.setPattRatio=function(t){return M.setPattRatio(this.id,t)},u.prototype.getPattRatio=function(){return M.getPattRatio(this.id)},u.prototype.setImageProcMode=function(t){return M.setImageProcMode(this.id,t)},u.prototype.getImageProcMode=function(){return M.getImageProcMode(this.id)},u.prototype.debugDraw=function(){var t=new Uint8ClampedArray(Module.HEAPU8.buffer,this._bwpointer,this.framesize),e=new ImageData(t,this.canvas.width,this.canvas.height);this.ctx.putImageData(e,0,0);for(var r=this.getMarkerNum(),i=0;i<r;i++)this._debugMarker(this.getMarker(i))},u.prototype._initialize=function(){this.id=M.setup(this.canvas.width,this.canvas.height,this.cameraParam.id);var t=M.frameMalloc;this.framepointer=t.framepointer,this.framesize=t.framesize,this.dataHeap=new Uint8Array(Module.HEAPU8.buffer,this.framepointer,this.framesize),this.camera_mat=new Float64Array(Module.HEAPU8.buffer,t.camera,16),this.marker_transform_mat=new Float64Array(Module.HEAPU8.buffer,t.transform,12),this.setProjectionNearPlane(.1),this.setProjectionFarPlane(1e3);var e=this;setTimeout(function(){e.onload&&e.onload(),e.dispatchEvent({name:"load",target:e})},1)},u.prototype._copyImageToHeap=function(t){t||(t=this.image),this.ctx.save(),"portrait"===this.orientation?(this.ctx.translate(this.canvas.width,0),this.ctx.rotate(Math.PI/2),this.ctx.drawImage(t,0,0,this.canvas.height,this.canvas.width)):this.ctx.drawImage(t,0,0,this.canvas.width,this.canvas.height),this.ctx.restore();var e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),r=e.data;return!!this.dataHeap&&(this.dataHeap.set(r),!0)},u.prototype._debugMarker=function(t){var e,r;e=t.vertex;var i=this.ctx;i.strokeStyle="red",i.beginPath(),i.moveTo(e[0][0],e[0][1]),i.lineTo(e[1][0],e[1][1]),i.stroke(),i.beginPath(),i.moveTo(e[2][0],e[2][1]),i.lineTo(e[3][0],e[3][1]),i.stroke(),i.strokeStyle="green",i.beginPath(),i.lineTo(e[1][0],e[1][1]),i.lineTo(e[2][0],e[2][1]),i.stroke(),i.beginPath(),i.moveTo(e[3][0],e[3][1]),i.lineTo(e[0][0],e[0][1]),i.stroke(),r=t.pos,i.beginPath(),i.arc(r[0],r[1],8,0,2*Math.PI),i.fillStyle="red",i.fill()},u.getUserMedia=function(t){var e=t.facingMode||"environment",r=t.onSuccess,i=t.onError||function(t){console.error("ARController.getUserMedia",t)},a=document.createElement("video"),o=function(){0!==this.videoWidth&&r(a)},n=!1,s=["touchstart","touchend","touchmove","touchcancel","click","mousedown","mouseup","mousemove","keydown","keyup","keypress","scroll"],h=function(){n&&(a.play(),a.paused||s.forEach(function(t){window.removeEventListener(t,h,!0)}))};s.forEach(function(t){window.addEventListener(t,h,!0)});var d=function(t){a.addEventListener("loadedmetadata",o,!1),a.src=window.URL.createObjectURL(t),n=!0,h()},u={},c={};t.width&&(c.width=t.width,"object"==typeof t.width?(t.width.max&&(u.maxWidth=t.width.max),t.width.min&&(u.minWidth=t.width.max)):u.maxWidth=t.width),t.height&&(c.height=t.height,"object"==typeof t.height?(t.height.max&&(u.maxHeight=t.height.max),t.height.min&&(u.minHeight=t.height.max)):u.maxHeight=t.height),c.facingMode=e,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var M={audio:!1,video:{mandatory:u}};return navigator.getUserMedia?navigator.getUserMedia(M,d,i):i("navigator.getUserMedia is not supported on your browser"),a},u.getUserMediaARController=function(t){var e={};for(var r in t)e[r]=t[r];var i=t.onSuccess,a=t.cameraParam;e.onSuccess=function(){new c(a,function(){var e=this,r=t.maxARVideoSize||Math.max(o.videoWidth,o.videoHeight),a=r/Math.max(o.videoWidth,o.videoHeight),n=a*o.videoWidth,s=a*o.videoHeight;if(o.videoWidth<o.videoHeight){var h=n;n=s,s=h}var d=new u(n,s,e);d.image=o,o.videoWidth<o.videoHeight?(d.orientation="portrait",d.videoWidth=o.videoHeight,d.videoHeight=o.videoWidth):(d.orientation="landscape",d.videoWidth=o.videoWidth,d.videoHeight=o.videoHeight),i(d,e)},function(t){console.error("ARController: Failed to load ARCameraParam",t)})};var o=this.getUserMedia(e);return o};var c=function(t,e,r){this.id=-1,this._src="",this.complete=!1,this.onload=e,this.onerror=r,t&&this.load(t)};c.prototype.load=function(t){if(""!==this._src)throw"ARCameraParam: Trying to load camera parameters twice.";if(this._src=t,t){var e=this;M.loadCamera(t,function(t){e.id=t,e.complete=!0,e.onload()},function(t){e.onerror(t)})}},Object.defineProperty(c.prototype,"src",{set:function(t){this.load(t)},get:function(){return this._src}}),c.prototype.dispose=function(){-1!==this.id&&M.deleteCamera(this.id),this.id=-1,this._src="",this.complete=!1};var M={UNKNOWN_MARKER:-1,PATTERN_MARKER:0,BARCODE_MARKER:1,loadCamera:o,addMarker:e,addMultiMarker:a},g=["setup","teardown","setLogLevel","getLogLevel","setDebugMode","getDebugMode","getProcessingImage","setMarkerInfoDir","setMarkerInfoVertex","getTransMatSquare","getTransMatSquareCont","getTransMatMultiSquare","getTransMatMultiSquareRobust","getMultiMarkerNum","getMultiMarkerCount","detectMarker","getMarkerNum","getMarker","getMultiEachMarker","setProjectionNearPlane","getProjectionNearPlane","setProjectionFarPlane","getProjectionFarPlane","setThresholdMode","getThresholdMode","setThreshold","getThreshold","setPatternDetectionMode","getPatternDetectionMode","setMatrixCodeType","getMatrixCodeType","setLabelingMode","getLabelingMode","setPattRatio","getPattRatio","setImageProcMode","getImageProcMode"],m=0,f=0,p=0;window.artoolkit=M,window.ARController=u,window.ARCameraParam=c,window.Module?t():window.Module={onRuntimeInitialized:function(){t()}}}();